<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Detail - Fairlios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<%- include("partials/header") %>
<body class="bg-light">
<div class="container py-md-3 py-2 px-4 d-print-none">
  <%- include("partials/flash") %>
  
  <div class="container my-3">
  <!-- Compact Group Info Bar -->
  <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-between bg-primary text-white rounded-4 shadow-sm px-4 py-2 gap-2">

    <!-- Logged-in User -->
    <% if (user) { %>
    <div class="d-flex align-items-center">
      <img src="https://api.dicebear.com/9.x/initials/svg?seed=<%= user.name %>"
                alt="avatar"
                class="rounded-circle border border-2 border-light shadow-sm me-1"
                width="25" height="25">
      <span class="fw-semibold">Hello, <%= user.name %> üëÄ</span>
    </div>
    <% } %>

    <!-- Group Code -->
    <div class="d-flex align-items-center">
      <i class="bi bi-people-fill fs-5 me-2"></i>
      <span class="fw-semibold">Group: <%= group.expenseCode %></span>
    </div>

    <!-- Avg Share -->
    <div class="d-flex align-items-center bg-white text-primary px-2 py-1 rounded-pill shadow-sm">
      <span class="me-2 small text-muted">Avg Share</span>
      <span class="fw-bold fs-6"><%= user.currencySymbol %> <%= avgShare %></span>
    </div>

    <!-- Members Count -->
    <div class="d-flex align-items-center bg-white text-primary px-2 py-1 rounded-pill shadow-sm">
      <i class="bi bi-people me-1 fs-6"></i>
      <span class="fw-bold fs-6"><%= group.members.length %> <%= group.members.length === 1 ? " Member" : " Members" %></span>
    </div>

  </div>
</div>

  <!-- Expenses List -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex flex-wrap justify-content-between align-items-center rounded-top">
      <span class="fw-bold mb-2"><i class="bi bi-receipt me-2"></i> All Expenses</span>
      <div>
        <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
          <i class="bi bi-folder-plus me-2"></i>Add
        </button>        
        <a href="/expense/group-detail/print/<%= group.expenseCode %>?download=true" class="btn btn-sm btn-primary text-decoration-none text-white" target="framename">
          <i class="bi bi-printer me-2"></i>Print
        </a>
        <% if (user._id.toString() === group.createdBy.toString()) { %>
        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteGroupModal">
          <i class="bi bi-trash3 me-2"></i>Delete
        </button>
        <% } %>
      </div>
    </div>

    <!-- <div class="card-body"> -->
      <% if (expenses.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle mb-0">
        <thead class="table-primary">
          <tr>
            <th>Title</th>
            <th>Amount</th>
            <th class="d-none d-md-table-cell">Note</th>
            <th class="d-none d-md-table-cell">Date</th>
            <th>Paid By</th>
          </tr>
        </thead>
        <tbody>
          <% expenses.forEach(exp => { %>
            <tr>
              <td class="fw-bold"><%= exp.title %></td>
              <td class="text-success"><%= user.currencySymbol %> <%= exp.amount %></td>
              <td class="d-none d-md-table-cell"><%= exp.note || "-" %></td>
              <td class="d-none d-md-table-cell"><%= exp.date.toDateString() %></td>
              <td class="align-middle">
                <div class="d-flex align-items-center">
                  <!-- Avatar -->
                  <img src="https://api.dicebear.com/9.x/initials/svg?seed=<%= exp.createdBy.name %>"
                      alt="avatar"
                      width="35" height="35"
                      class="rounded-circle me-2 border shadow-sm">
                  <!-- Name + Eye Icon -->
                  <div class="d-flex align-items-center gap-1 flex-wrap">
                    <span class="fw-semibold"><%= exp.createdBy.name %></span>
                    <a data-bs-toggle="modal" 
                      data-bs-target="#viewExpenseModal<%= exp._id %>">
                      <i class="bi bi-eye text-dark"></i>
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
        </table>
            <!-- pagination -->
    <% if (paginatedMeta.totalDocs > 12) { %>
    <nav aria-label="Page navigation">
      <ul class="pagination flex-wrap">
        <% if (paginatedMeta.hasPrevPage) { %>
          <li class="page-item">
            <a class="page-link" href="/expense/group-detail/<%= group.expenseCode %>/?page=<%= paginatedMeta.prevPage %>" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        <% }else { %>
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
       <% } %>
        <% for (let i = 1; i <= paginatedMeta.totalPages; i++) { %>
          <li class="page-item <%= i === paginatedMeta.page ? 'active' : '' %>">
            <a class="page-link" href="/expense/group-detail/<%= group.expenseCode %>/?page=<%= i %>"><%= i %></a>
          </li>
        <% } %>
        <% if (paginatedMeta.hasNextPage) { %>
          <li class="page-item">
            <a class="page-link" href="/expense/group-detail/<%= group.expenseCode %>/?page=<%= paginatedMeta.nextPage %>" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        <% } else{ %>
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        <% } %>
      </ul>
    </nav>
    <% } %>
    <!-- /pagination -->
      </div>
      <% } else { %>
        <p class="text-muted">No expenses yet.</p>
      <% } %>
    <!-- </div> -->
  </div>
    <!-- Per-User Totals -->
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-gradient bg-success text-white fw-bold">
          <i class="bi bi-cash-coin me-2"></i> Per Person Totals
        </div>
        <div class="card-body p-0">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Paid By</th>
                <th>Total Spent</th>
              </tr>
            </thead>
            <tbody>
              <% Object.keys(perUserTotals).forEach(uid => { %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <img src="https://api.dicebear.com/9.x/initials/svg?seed=<%= perUserTotals[uid].name %>"
                          alt="avatar"
                          width="30" height="30"
                          class="rounded-circle me-2 border shadow-sm">
                      <%= perUserTotals[uid].name %>
                    </div>
                  </td>
                  <td class="fw-bold text-success"><%= user.currencySymbol %> <%= perUserTotals[uid].total %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Balances -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-gradient bg-warning fw-bold">
          <i class="bi bi-wallet2 me-2"></i> Balances (Who Owes Who)
        </div>
        <div class="card-body p-0">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Member</th>
                <th>Balance</th>
              </tr>
            </thead>
            <tbody>
              <% balances.forEach(b => { %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <img src="https://api.dicebear.com/9.x/initials/svg?seed=<%= b.name %>"
                          alt="avatar"
                          width="30" height="30"
                          class="rounded-circle me-2 border shadow-sm">
                      <%= b.name %>
                    </div>
                  </td>
                  <td>
                    <% if (b.balance > 0) { %>
                      <span class="text-success fw-bold">Gets <%= user.currencySymbol %> <%= b.status %></span>
                    <% } else if (b.balance < 0) { %>
                      <span class="text-danger fw-bold">Owes <%= user.currencySymbol %> <%= b.status %></span>
                    <% } else { %>
                      <span class="text-muted"><%= b.status %></span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Expense Modals -->
<% expenses.forEach(exp => { %>
<div class="modal fade" id="viewExpenseModal<%= exp._id %>" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white p-2">
        <h5 class="modal-title">Expense Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-2 border-bottom">
          <div class="col-3"><strong>Title:</strong></div>
          <div class="col-9"><%= exp.title %></div><div class="w-100"></div>
        </div>
        <div class="row mb-2 border-bottom">
          <div class="col-3"><strong>Amount:</strong></div>
          <div class="col-9"><%= exp.amount %></div><div class="w-100"></div>
        </div>
        <div class="row mb-2 border-bottom">
          <div class="col-3"><strong>By:</strong></div>
          <div class="col-9"><%= exp.createdBy?.name || "Unknown" %></div><div class="w-100"></div>
        </div>
        <div class="row mb-2 border-bottom">
          <div class="col-3"><strong>Date:</strong></div>
          <div class="col-9"><%= exp.date.toDateString() %></div><div class="w-100"></div>
        </div>
        <div class="row mb-2 border-bottom">
          <div class="col-3"><strong>Notes:</strong></div>
          <div class="col-9"><%= exp.note %></div><div class="w-100"></div>
        </div>
        <!-- Delete button (only if creator) -->
                  <% if (user._id.toString() === exp.createdBy._id.toString()) { %>
                    <form action="/expense/delete/<%= exp._id %>" method="POST" class="d-inline"
                          onsubmit="return confirm('Are you sure you want to delete this expense?');">
                      <button type="submit" 
                              class="btn btn-sm btn-outline-danger ms-2 d-flex align-items-center justify-content-center"
                              title="Delete Expense">
                        <i class="bi bi-trash3 me-2"></i> Delete
                      </button>
                    </form>
                  <% } %>
      </div>
    </div>
  </div>
</div>
<% }) %>

<!-- Delete Group Modal -->
<div class="modal fade" id="deleteGroupModal" tabindex="-1" aria-labelledby="deleteGroupLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="/group/delete/<%= group.expenseCode %>">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteGroupLabel">Confirm Delete Group</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-danger">
            ‚ö†Ô∏è This action cannot be undone. All expenses in this group will be deleted.
          </p>
          <p>Please type the group code <strong><%= group.expenseCode %></strong> to confirm:</p>
          <input type="text" name="confirmCode" class="form-control" placeholder="Enter group code" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Group</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="/expense/add/<%= group.expenseCode %>">
        <div class="modal-header">
          <h5 class="modal-title" id="addExpenseLabel">Add New Expense</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" value="<%= formData.title %>" required>
          </div>
          <div class="mb-3">
            <label for="amount" class="form-label">Amount</label>
            <input type="number" class="form-control" id="amount" name="amount" value="<%= formData.amount %>" min="0" required>
          </div>
          <div class="mb-3">
            <label for="note" class="form-label">Note (optional)</label>
            <textarea class="form-control" id="note" name="note" rows="2"><%= formData.note %></textarea>
          </div>
          <%- include("partials/flash") %>
          <small class="text-muted">You are adding expense in group <strong><%= group.expenseCode %></strong></small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Expense</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include("partials/footer") %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
